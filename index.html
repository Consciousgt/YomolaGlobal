<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yomola Global - Contribution Agency</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9', // Sky Blue
                            600: '#0284c7',
                            700: '#0369a1',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs (Compat for easier CDN usage) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Outfit', sans-serif;
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        .animate-bounce-in {
            animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.9);
            }

            70% {
                opacity: 1;
                transform: scale(1.02);
            }

            100% {
                transform: scale(1);
            }
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 antialiased overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- CLOUD SERVICE (Firebase Adapter) ---
        // This replaces the synchronous DataService with an async one.

        const DB_CONFIG_KEY = 'yomola_firebase_config';

        const CloudService = {
            db: null,
            isConnected: false,

            // Initialize Firebase with provided config
            init: (config) => {
                try {
                    if (firebase.apps.length === 0) {
                        firebase.initializeApp(config);
                    }
                    CloudService.db = firebase.firestore();
                    CloudService.isConnected = true;
                    localStorage.setItem(DB_CONFIG_KEY, JSON.stringify(config));
                    return true;
                } catch (e) {
                    console.error("Firebase Init Error", e);
                    return false;
                }
            },

            loadConfig: () => {
                const conf = localStorage.getItem(DB_CONFIG_KEY);
                return conf ? JSON.parse(conf) : null;
            },

            clearConfig: () => localStorage.removeItem(DB_CONFIG_KEY),

            // Async Data Methods
            loadApp: async () => {
                if (!CloudService.db) throw new Error("Database not connected");
                const snap = await CloudService.db.collection('settings').doc('app_global').get();
                if (!snap.exists) return { staff: [], businessName: 'Yomola Global' }; // Default
                return snap.data();
            },

            saveApp: async (data) => {
                if (!CloudService.db) return;
                await CloudService.db.collection('settings').doc('app_global').set(data);
            },

            loadClients: async () => {
                if (!CloudService.db) return [];
                const snap = await CloudService.db.collection('clients').get();
                return snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            },

            saveClient: async (client) => {
                if (!CloudService.db) return;
                // Use string ID for doc to prevent duplicates easily if needed, but random ID is fine
                await CloudService.db.collection('clients').doc(String(client.id)).set(client);
            },

            loadTransactions: async () => {
                if (!CloudService.db) return [];
                const snap = await CloudService.db.collection('transactions').orderBy('date', 'desc').limit(2000).get(); // Limit for performance
                return snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            },

            saveTransaction: async (tx) => {
                if (!CloudService.db) return;
                await CloudService.db.collection('transactions').doc(String(tx.id)).set(tx);
            },

            // Backup/Utility for migration (Optional, could act as Export)
            exportData: async () => {
                // Implementation for Full Dump if needed
            }
        };

        // --- BACKWARDS COMPATIBILITY / MANUAL DATA SERVICE (For fallback or initial migration state) ---
        // We will keep a minimal DataService just for "Offline Setup" if we wanted, but User requested "Cloud Only".
        // Use CloudService exclusively for data.

        // --- UTILS ---
        const formatMoney = (amount) => '₦' + (amount || 0).toLocaleString();
        const formatDate = (dateStr) => new Date(dateStr).toLocaleDateString();

        // --- COMPONENTS ---

        // 1. SETUP SCREEN (Cloud Config)
        const SetupScreen = ({ onConnect }) => {
            const [config, setConfig] = useState({ apiKey: '', authDomain: '', projectId: '' });
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                if (!config.apiKey || !config.projectId) {
                    setLoading(false);
                    return setError("API Key and Project ID are required");
                }
                const success = CloudService.init(config);
                if (success) {
                    onConnect();
                } else {
                    setError("Invalid Configuration");
                }
                setLoading(false);
            };

            return (
                <div className="flex items-center justify-center h-full bg-slate-900 text-white">
                    <div className="bg-white text-slate-800 p-8 rounded-2xl shadow-xl w-full max-w-md m-4">
                        <div className="text-center mb-6">
                            <h1 className="text-2xl font-bold mb-2">Cloud Setup</h1>
                            <p className="text-slate-500 text-sm">Connect to your Firebase Project to enable synchronization.</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold uppercase text-slate-500 mb-1">API Key</label>
                                <input type="text" value={config.apiKey} onChange={e => setConfig({ ...config, apiKey: e.target.value })} className="w-full p-3 border rounded-lg outline-none focus:border-brand-500" placeholder="AIzaSy..." />
                            </div>
                            <div>
                                <label className="block text-xs font-bold uppercase text-slate-500 mb-1">Project ID</label>
                                <input type="text" value={config.projectId} onChange={e => setConfig({ ...config, projectId: e.target.value })} className="w-full p-3 border rounded-lg outline-none focus:border-brand-500" placeholder="yomola-app" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold uppercase text-slate-500 mb-1">Auth Domain (Optional)</label>
                                <input type="text" value={config.authDomain} onChange={e => setConfig({ ...config, authDomain: e.target.value })} className="w-full p-3 border rounded-lg outline-none focus:border-brand-500" placeholder="yomola-app.firebaseapp.com" />
                            </div>
                            {error && <p className="text-red-500 text-sm font-bold">{error}</p>}
                            <button disabled={loading} className="w-full py-3 bg-brand-600 text-white rounded-lg font-bold hover:bg-brand-700 transition disabled:opacity-50">
                                {loading ? 'Connecting...' : 'Connect Database'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // 2. AUTH SCREEN (Staff & Client)
        const AuthScreen = ({ onLogin, onSetup, hasAccount }) => {
            const [mode, setMode] = useState('staff'); // 'staff' | 'client'
            const [val, setVal] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                setError('');
                if (mode === 'staff') {
                    if (val.length < 4) return setError("PIN must be 4 digits");
                    hasAccount ? onLogin({ type: 'staff', pin: val }) : onSetup(val);
                } else {
                    // Client Login
                    if (val.length < 10) return setError("Enter a valid phone number");
                    onLogin({ type: 'client', phone: val });
                }
            };

            return (
                <div className="flex items-center justify-center h-full bg-brand-900 text-white px-4">
                    <div className="bg-white text-slate-800 p-8 rounded-2xl shadow-xl w-full max-w-sm">
                        <div className="text-center mb-6">
                            <h1 className="text-3xl font-bold text-brand-900">Yomola Global</h1>
                            <p className="text-slate-500 mt-2">Secure Access Portal</p>
                        </div>

                        {/* Tabs */}
                        {hasAccount && (
                            <div className="flex bg-slate-100 p-1 rounded-xl mb-6">
                                <button onClick={() => { setMode('staff'); setVal(''); setError(''); }} className={`flex-1 py-2 text-sm font-bold rounded-lg transition ${mode === 'staff' ? 'bg-white shadow text-brand-600' : 'text-slate-400'}`}>Staff Login</button>
                                <button onClick={() => { setMode('client'); setVal(''); setError(''); }} className={`flex-1 py-2 text-sm font-bold rounded-lg transition ${mode === 'client' ? 'bg-white shadow text-brand-600' : 'text-slate-400'}`}>Client Portal</button>
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-2">
                                    {mode === 'staff' ? (hasAccount ? 'Enter Staff PIN' : 'Create Admin PIN') : 'Enter Mobile Number'}
                                </label>
                                <input
                                    type={mode === 'staff' ? "password" : "tel"}
                                    value={val}
                                    onChange={e => { setVal(e.target.value.replace(/\D/g, '')); setError(''); }}
                                    className={`w-full text-center p-4 border rounded-xl focus:ring-2 focus:ring-brand-500 outline-none font-mono ${mode === 'staff' ? 'text-3xl tracking-widest' : 'text-xl tracking-normal'}`}
                                    placeholder={mode === 'staff' ? "••••" : "080..."}
                                    autoFocus
                                    maxLength={mode === 'staff' ? 4 : 15}
                                />
                                {error && <p className="text-red-500 text-sm text-center mt-2">{error}</p>}
                            </div>
                            <button className="w-full py-4 bg-brand-600 text-white rounded-xl font-bold text-lg hover:bg-brand-700 transition shadow-lg shadow-brand-200">
                                {hasAccount ? (mode === 'staff' ? 'Login to Dashboard' : 'View My Dashboard') : 'Initialize System'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // 2. DASHBOARD LAYOUT
        const Layout = ({ children, onViewChange, currentView, onLogout, currentUser }) => {
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

            return (
                <div className="flex h-screen bg-slate-50 text-slate-800">
                    {/* Mobile Overlay */}
                    {isMobileMenuOpen && (
                        <div
                            className="fixed inset-0 bg-black/50 z-20 md:hidden"
                            onClick={() => setIsMobileMenuOpen(false)}
                        ></div>
                    )}

                    {/* Sidebar */}
                    <aside className={`fixed inset-y-0 left-0 z-30 w-64 bg-brand-900 text-white flex flex-col transition-transform duration-300 md:translate-x-0 md:static ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-6 border-b border-brand-800 flex justify-between items-center">
                            <div>
                                <h2 className="text-xl font-bold tracking-wide">Yomola Global</h2>
                                <p className="text-xs text-brand-400 mt-1">Contribution Agency</p>
                            </div>
                            <button onClick={() => setIsMobileMenuOpen(false)} className="md:hidden text-brand-300 hover:text-white">
                                <i data-lucide="x" className="w-6 h-6"></i>
                            </button>
                        </div>
                        <nav className="flex-1 p-4 space-y-2">
                            {[
                                { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
                                { id: 'clients', label: 'Clients', icon: 'users' },
                                { id: 'transactions', label: 'Transactions', icon: 'arrow-right-left' },
                                { id: 'reports', label: 'Reports', icon: 'file-bar-chart' },
                                { id: 'settings', label: 'Settings', icon: 'settings' },
                            ].map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => { onViewChange(item.id); setIsMobileMenuOpen(false); }}
                                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition ${currentView === item.id ? 'bg-brand-700 text-white shadow-lg' : 'text-brand-100 hover:bg-brand-800'}`}
                                >
                                    <i data-lucide={item.icon} className="w-5 h-5"></i>
                                    <span className="font-medium">{item.label}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t border-brand-800">
                            <div className="mb-4 px-2">
                                <div className="text-xs text-brand-400 uppercase font-bold">Logged in as</div>
                                <div className="font-bold text-white truncate">{currentUser?.name || 'Admin'}</div>
                            </div>
                            <button onClick={onLogout} className="w-full flex items-center gap-2 px-4 py-2 text-brand-300 hover:text-white transition">
                                <i data-lucide="log-out" className="w-5 h-5"></i> Logout
                            </button>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col h-full overflow-hidden w-full">
                        <header className="bg-white px-4 md:px-8 py-4 shadow-sm z-10 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setIsMobileMenuOpen(true)} className="md:hidden p-2 text-slate-600 hover:bg-slate-100 rounded-lg">
                                    <i data-lucide="menu" className="w-6 h-6"></i>
                                </button>
                                <h2 className="text-xl font-bold text-slate-800 capitalize hidden md:block">{currentView}</h2>
                            </div>
                            <div className="flex items-center gap-3">
                                <div className="hidden md:block text-right">
                                    <p className="text-sm font-bold text-slate-700">{currentUser?.name}</p>
                                    <p className="text-xs text-slate-500 uppercase">{currentUser?.role || 'Staff'}</p>
                                </div>
                                <div className="w-10 h-10 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center font-bold text-lg border-2 border-brand-50">
                                    {currentUser?.name?.charAt(0) || 'A'}
                                </div>
                            </div>
                        </header>
                        <div className="flex-1 overflow-auto p-4 md:p-8">
                            {children}
                        </div>
                    </main>
                </div>
            );
        };

        // 3. FEATURE VIEWS



        // 3. FEATURE VIEWS

        const ClientManager = ({ clients, onAddClient, onSelectClient }) => {
            const [showForm, setShowForm] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [newClient, setNewClient] = useState({ name: '', phone: '', email: '', plan: 'Daily', address: '' });

            const filteredClients = clients.filter(c => c.name.toLowerCase().includes(searchTerm.toLowerCase()) || c.phone.includes(searchTerm));

            const handleSubmit = (e) => {
                e.preventDefault();
                onAddClient({ ...newClient, id: Date.now(), balance: 0, createdAt: new Date().toISOString() });
                setNewClient({ name: '', phone: '', email: '', plan: 'Daily', address: '' });
                setShowForm(false);
            };

            return (
                <div className="space-y-6">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div className="relative w-full md:w-96">
                            <input
                                type="text"
                                placeholder="Search clients..."
                                value={searchTerm}
                                onChange={e => setSearchTerm(e.target.value)}
                                className="w-full pl-10 pr-4 py-2 border rounded-xl focus:ring-2 focus:ring-brand-500 outline-none"
                            />
                            <i data-lucide="search" className="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
                        </div>
                        <button onClick={() => setShowForm(true)} className="w-full md:w-auto bg-brand-600 text-white px-4 py-2 rounded-xl font-bold hover:bg-brand-700 flex items-center justify-center gap-2">
                            <i data-lucide="user-plus" className="w-4 h-4"></i> Add Client
                        </button>
                    </div>

                    {/* Add Client Modal */}
                    {showForm && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 animate-bounce-in">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold">Add New Client</h3>
                                    <button onClick={() => setShowForm(false)} className="text-slate-400 hover:text-slate-600"><i data-lucide="x"></i></button>
                                </div>
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="text-sm font-medium block mb-1">Full Name</label><input required value={newClient.name} onChange={e => setNewClient({ ...newClient, name: e.target.value })} className="w-full border p-2 rounded-lg" /></div>
                                        <div><label className="text-sm font-medium block mb-1">Phone</label><input required type="tel" value={newClient.phone} onChange={e => setNewClient({ ...newClient, phone: e.target.value })} className="w-full border p-2 rounded-lg" /></div>
                                    </div>
                                    <div><label className="text-sm font-medium block mb-1">Email (Optional)</label><input type="email" value={newClient.email} onChange={e => setNewClient({ ...newClient, email: e.target.value })} className="w-full border p-2 rounded-lg" /></div>
                                    <div><label className="text-sm font-medium block mb-1">Address</label><input value={newClient.address} onChange={e => setNewClient({ ...newClient, address: e.target.value })} className="w-full border p-2 rounded-lg" /></div>
                                    <div>
                                        <label className="text-sm font-medium block mb-1">Savings Plan</label>
                                        <select value={newClient.plan} onChange={e => setNewClient({ ...newClient, plan: e.target.value })} className="w-full border p-2 rounded-lg">
                                            <option>Daily</option><option>Weekly</option><option>Monthly</option><option>Irregular</option>
                                        </select>
                                    </div>
                                    <button className="w-full bg-brand-600 text-white py-3 rounded-xl font-bold hover:bg-brand-700 mt-4">Register Client</button>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Clients Table */}
                    <div className="bg-white rounded-xl shadow-sm overflow-hidden border border-slate-100 overflow-x-auto">
                        <table className="w-full text-left text-sm min-w-[600px]">
                            <thead className="bg-slate-50 text-slate-500 font-medium">
                                <tr>
                                    <th className="p-4">Name</th>
                                    <th className="p-4">Plan</th>
                                    <th className="p-4">Phone</th>
                                    <th className="p-4 text-right">Balance</th>
                                    <th className="p-4 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {filteredClients.map(client => (
                                    <tr key={client.id} className="hover:bg-slate-50 transition">
                                        <td className="p-4 font-medium text-slate-900">{client.name}</td>
                                        <td className="p-4"><span className="px-2 py-1 bg-brand-50 text-brand-700 rounded text-xs font-bold">{client.plan}</span></td>
                                        <td className="p-4 text-slate-500">{client.phone}</td>
                                        <td className="p-4 text-right font-bold text-slate-900">{formatMoney(client.balance)}</td>
                                        <td className="p-4 text-center">
                                            <button onClick={() => onSelectClient(client.id)} className="text-brand-600 hover:text-brand-800 font-medium text-xs">View</button>
                                        </td>
                                    </tr>
                                ))}
                                {filteredClients.length === 0 && <tr><td colSpan="5" className="p-8 text-center text-slate-400">No clients found</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const DashboardHome = ({ clients, transactions }) => {
            const stats = useMemo(() => {
                const totalClients = clients.length;
                const totalHoldings = clients.reduce((sum, c) => sum + (c.balance || 0), 0);

                // Enhanced Date Logic for Today's Deposits
                const todayStr = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                const todaysTx = transactions.filter(t => t.date === todayStr && t.type === 'DEPOSIT');
                const todaysVolume = todaysTx.reduce((sum, t) => sum + t.amount, 0);

                return { totalClients, totalHoldings, todaysVolume };
            }, [clients, transactions]);

            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-brand-500">
                            <p className="text-slate-500 text-sm font-medium uppercase">Total Holdings</p>
                            <p className="text-3xl font-bold text-slate-800 mt-2">{formatMoney(stats.totalHoldings)}</p>
                        </div>
                        <div className="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-emerald-500">
                            <p className="text-slate-500 text-sm font-medium uppercase">Today's Deposits</p>
                            <p className="text-3xl font-bold text-slate-800 mt-2">{formatMoney(stats.todaysVolume)}</p>
                        </div>
                        <div className="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-purple-500">
                            <p className="text-slate-500 text-sm font-medium uppercase">Active Clients</p>
                            <p className="text-3xl font-bold text-slate-800 mt-2">{stats.totalClients}</p>
                        </div>
                    </div>
                </div>
            );
        };

        // 4. CLIENT DETAIL & TRANSACTIONS
        const ClientDetail = ({ client, transactions, onBack, onTransaction }) => {
            const [showTxForm, setShowTxForm] = useState(false);
            const [txData, setTxData] = useState({ type: 'DEPOSIT', amount: 0, method: 'Cash', date: new Date().toISOString().slice(0, 10) });

            // Statement Filters
            const [dateRange, setDateRange] = useState({
                start: new Date(new Date().getFullYear(), 0, 1).toISOString().slice(0, 10), // Jan 1st
                end: new Date().toISOString().slice(0, 10)
            });

            const clientTx = transactions.filter(t => t.clientId === client.id).sort((a, b) => new Date(b.date) - new Date(a.date));
            const filteredTx = clientTx.filter(t => t.date >= dateRange.start && t.date <= dateRange.end);

            const handleTxSubmit = (e) => {
                e.preventDefault();
                onTransaction({
                    id: Date.now(),
                    clientId: client.id,
                    ...txData,
                    amount: parseFloat(txData.amount)
                });
                setShowTxForm(false);
                setTxData({ type: 'DEPOSIT', amount: 0, method: 'Cash', date: new Date().toISOString().slice(0, 10) });
            };

            const downloadStatement = () => {
                const doc = new window.jspdf.jsPDF();

                // Header
                doc.setFillColor(12, 74, 110); // Brand 900
                doc.rect(0, 0, 210, 40, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(22);
                doc.text("Yomola Global", 14, 20);
                doc.setFontSize(12);
                doc.text("Contribution Agency", 14, 28);

                doc.setTextColor(0, 0, 0);
                doc.setFontSize(16);
                doc.text(`Statement of Account`, 14, 55);

                doc.setFontSize(10);
                doc.text(`Client: ${client.name}`, 14, 65);
                doc.text(`Phone: ${client.phone}`, 14, 70);
                doc.text(`Period: ${formatDate(dateRange.start)} - ${formatDate(dateRange.end)}`, 14, 75);
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, 150, 65);

                // Summary Box
                const totalDep = filteredTx.filter(t => t.type === 'DEPOSIT').reduce((a, b) => a + b.amount, 0);
                const totalWith = filteredTx.filter(t => t.type === 'WITHDRAWAL').reduce((a, b) => a + b.amount, 0);

                doc.setDrawColor(200);
                doc.rect(130, 80, 70, 25);
                doc.text(`Total Deposits: ${formatMoney(totalDep)}`, 135, 88);
                doc.text(`Total Withdrawals: ${formatMoney(totalWith)}`, 135, 95);
                doc.setFont(undefined, 'bold');
                doc.text(`Net Change: ${formatMoney(totalDep - totalWith)}`, 135, 102);
                doc.setFont(undefined, 'normal');

                const tableData = filteredTx.map(t => [t.date, t.type, t.method, formatMoney(t.amount)]);
                doc.autoTable({
                    startY: 115,
                    head: [['Date', 'Type', 'Method', 'Amount']],
                    body: tableData,
                    theme: 'striped',
                    headStyles: { fillColor: [14, 165, 233] },
                });

                doc.save(`Statement_${client.name}_${dateRange.start}_to_${dateRange.end}.pdf`);
            };

            return (
                <div className="space-y-6">
                    <button onClick={onBack} className="text-slate-500 hover:text-slate-700 flex items-center gap-2 mb-4">
                        <i data-lucide="arrow-left" className="w-4 h-4"></i> Back to Clients
                    </button>

                    {/* Header Card */}
                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-100 flex flex-col md:flex-row justify-between items-center gap-6">
                        <div>
                            <h2 className="text-3xl font-bold text-slate-800">{client.name}</h2>
                            <div className="flex gap-4 mt-2 text-slate-500 text-sm">
                                <span className="flex items-center gap-1"><i data-lucide="phone" className="w-4 h-4"></i> {client.phone}</span>
                                <span className="flex items-center gap-1"><i data-lucide="map-pin" className="w-4 h-4"></i> {client.address || 'No Address'}</span>
                            </div>
                            <div className="mt-4 inline-block bg-brand-50 text-brand-700 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide">
                                {client.plan} Savings Plan
                            </div>
                        </div>
                        <div className="text-right">
                            <p className="text-sm text-slate-400 font-medium uppercase">Current Balance</p>
                            <p className="text-5xl font-bold text-brand-600 tracking-tight">{formatMoney(client.balance)}</p>
                            <div className="flex gap-2 mt-4 justify-end">
                                <button onClick={() => { setTxData({ ...txData, type: 'DEPOSIT' }); setShowTxForm(true); }} className="bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-2 rounded-lg font-bold shadow-lg shadow-emerald-200 transition">+ Deposit</button>
                                <button onClick={() => { setTxData({ ...txData, type: 'WITHDRAWAL' }); setShowTxForm(true); }} className="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-bold shadow-lg shadow-red-200 transition">- Withdraw</button>
                            </div>
                        </div>
                    </div>

                    {/* Transaction History & Filters */}
                    <div className="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div className="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                            <h3 className="font-bold text-lg">Transaction History</h3>
                            <div className="flex items-center gap-2 bg-slate-50 p-2 rounded-lg border border-slate-200">
                                <span className="text-xs font-bold text-slate-500 uppercase px-2">Statement Range:</span>
                                <input type="date" value={dateRange.start} onChange={e => setDateRange({ ...dateRange, start: e.target.value })} className="text-sm bg-transparent outline-none border-b border-slate-300 focus:border-brand-500" />
                                <span className="text-slate-400">-</span>
                                <input type="date" value={dateRange.end} onChange={e => setDateRange({ ...dateRange, end: e.target.value })} className="text-sm bg-transparent outline-none border-b border-slate-300 focus:border-brand-500" />
                                <button onClick={downloadStatement} className="ml-2 bg-brand-600 hover:bg-brand-700 text-white p-2 rounded-lg" title="Download PDF">
                                    <i data-lucide="download" className="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-50 text-slate-500 border-b">
                                <tr><th className="p-4">Date</th><th className="p-4">Type</th><th className="p-4">Method</th><th className="p-4 text-right">Amount</th></tr>
                            </thead>
                            <tbody className="divide-y divide-slate-50">
                                {clientTx.map(t => (
                                    <tr key={t.id} className="hover:bg-slate-50">
                                        <td className="p-4 text-slate-500">{t.date}</td>
                                        <td className="p-4">
                                            <span className={`px-2 py-1 rounded text-xs font-bold ${t.type === 'DEPOSIT' ? 'bg-emerald-50 text-emerald-700' : 'bg-red-50 text-red-700'}`}>
                                                {t.type}
                                            </span>
                                        </td>
                                        <td className="p-4 text-slate-600">{t.method}</td>
                                        <td className={`p-4 text-right font-bold ${t.type === 'DEPOSIT' ? 'text-emerald-600' : 'text-red-600'}`}>
                                            {t.type === 'DEPOSIT' ? '+' : '-'}{formatMoney(t.amount)}
                                        </td>
                                    </tr>
                                ))}
                                {clientTx.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-slate-300">No transactions recorded yet.</td></tr>}
                            </tbody>
                        </table>
                    </div>

                    {/* Transaction Modal */}
                    {showTxForm && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100">
                                <h3 className="text-xl font-bold mb-4">{txData.type === 'DEPOSIT' ? 'Record Deposit' : 'Record Withdrawal'}</h3>
                                <form onSubmit={handleTxSubmit} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase">Amount</label>
                                        <input type="number" required min="1" autoFocus value={txData.amount} onChange={e => setTxData({ ...txData, amount: e.target.value })} className="w-full text-3xl font-bold p-2 border-b-2 border-slate-200 focus:border-brand-500 outline-none" placeholder="0.00" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase">Date</label>
                                            <input type="date" required value={txData.date} onChange={e => setTxData({ ...txData, date: e.target.value })} className="w-full p-2 bg-slate-50 rounded" />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase">Method</label>
                                            <select value={txData.method} onChange={e => setTxData({ ...txData, method: e.target.value })} className="w-full p-2 bg-slate-50 rounded">
                                                <option>Cash</option><option>Transfer</option><option>POS</option>
                                            </select>
                                        </div>
                                    </div>

                                    {txData.type === 'WITHDRAWAL' && client.balance < txData.amount && (
                                        <div className="p-3 bg-red-50 text-red-600 text-xs rounded-lg font-bold">
                                            Warning: Insufficient Funds (Bal: {formatMoney(client.balance)})
                                        </div>
                                    )}

                                    <div className="flex gap-3 pt-4">
                                        <button type="button" onClick={() => setShowTxForm(false)} className="flex-1 py-3 text-slate-500 hover:bg-slate-50 rounded-lg font-bold">Cancel</button>
                                        <button className={`flex-1 py-3 text-white rounded-lg font-bold shadow-lg ${txData.type === 'DEPOSIT' ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-red-600 hover:bg-red-700'}`}>Confirm</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const NotificationToast = ({ message, onClose }) => (
            <div className="fixed bottom-6 right-6 bg-slate-900 text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-4 animate-bounce-in z-50">
                <div className="bg-emerald-500 rounded-full p-1"><i data-lucide="check" className="w-4 h-4"></i></div>
                <div>
                    <h4 className="font-bold text-sm">Notification Sent</h4>
                    <p className="text-xs text-slate-300">{message}</p>
                </div>
                <button onClick={onClose} className="ml-2 text-slate-500 hover:text-white"><i data-lucide="x" className="w-4 h-4"></i></button>
            </div>
        );

        // 4. CLIENT PORTAL (Read Only)
        const ClientPortal = ({ client, transactions, onLogout }) => {
            const [dateRange, setDateRange] = useState({ start: '', end: '' });

            const myTx = transactions.filter(t => t.clientId === client.id);
            const filteredTx = myTx.filter(t => {
                if (!dateRange.start && !dateRange.end) return true;
                const d = new Date(t.date);
                const start = dateRange.start ? new Date(dateRange.start) : new Date('1900-01-01');
                const end = dateRange.end ? new Date(dateRange.end) : new Date('2100-01-01');
                return d >= start && d <= end;
            });

            const downloadStatement = () => {
                const doc = new jspdf.jsPDF();
                doc.setFontSize(20);
                doc.setTextColor(22, 101, 52);
                doc.text("Yomola Global - Account Statement", 14, 22);
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Client: ${client.name}`, 14, 30);
                doc.text(`Phone: ${client.phone}`, 14, 35);
                doc.text(`Date Generated: ${new Date().toLocaleDateString()}`, 14, 40);

                const tableBody = filteredTx.map(t => [t.date, t.type, t.method, formatMoney(t.amount)]);
                doc.autoTable({
                    head: [['Date', 'Type', 'Method', 'Amount']],
                    body: tableBody,
                    startY: 45,
                    theme: 'grid',
                    headStyles: { fillColor: [22, 163, 74] }
                });
                doc.save(`statement_${client.name}.pdf`);
            };

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col">
                    {/* Header */}
                    <div className="bg-brand-900 text-white p-6 shadow-lg flex justify-between items-center">
                        <div>
                            <h1 className="text-xl font-bold">Yomola Global</h1>
                            <p className="text-brand-200 text-sm">Welcome, {client.name}</p>
                        </div>
                        <button onClick={onLogout} className="bg-brand-800 hover:bg-brand-700 px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2">
                            <i data-lucide="log-out" className="w-4 h-4"></i> Logout
                        </button>
                    </div>

                    {/* Content */}
                    <div className="flex-1 p-4 max-w-2xl mx-auto w-full space-y-6">
                        {/* Balance Card */}
                        <div className="bg-brand-600 text-white p-6 rounded-2xl shadow-xl transform transition hover:scale-[1.02] duration-300 relative overflow-hidden">
                            <div className="relative z-10">
                                <p className="text-brand-200 font-medium uppercase tracking-wider text-xs">Available Savings</p>
                                <h2 className="text-4xl font-bold mt-2">{formatMoney(client.balance)}</h2>
                            </div>
                            <i data-lucide="wallet" className="absolute right-[-20px] bottom-[-20px] w-32 h-32 text-brand-500 opacity-20"></i>
                        </div>

                        {/* Recent Activity */}
                        <div className="bg-white rounded-xl shadow-sm overflow-hidden border border-slate-100">
                            <div className="p-4 border-b border-slate-50 flex justify-between items-center">
                                <h3 className="font-bold text-slate-800">Recent Transactions</h3>
                                <div className="flex items-center gap-2">
                                    <input type="date" className="bg-slate-50 border-b text-xs p-1 outline-none" onChange={e => setDateRange({ ...dateRange, start: e.target.value })} />
                                    <button onClick={downloadStatement} className="text-brand-600 hover:bg-brand-50 p-2 rounded-full transition" title="Download Statement">
                                        <i data-lucide="download" className="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                            <div className="divide-y divide-slate-50 max-h-[500px] overflow-y-auto">
                                {filteredTx.map(t => (
                                    <div key={t.id} className="p-4 flex justify-between items-center hover:bg-slate-50 transition">
                                        <div className="flex items-center gap-3">
                                            <div className={`p-2 rounded-full ${t.type === 'DEPOSIT' ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'}`}>
                                                <i data-lucide={t.type === 'DEPOSIT' ? 'arrow-down-left' : 'arrow-up-right'} className="w-4 h-4"></i>
                                            </div>
                                            <div>
                                                <p className="font-bold text-sm text-slate-800">{t.type === 'DEPOSIT' ? 'Deposit' : 'Withdrawal'}</p>
                                                <p className="text-xs text-slate-400">{t.date} • {t.method}</p>
                                            </div>
                                        </div>
                                        <span className={`font-bold ${t.type === 'DEPOSIT' ? 'text-emerald-600' : 'text-slate-600'}`}>
                                            {t.type === 'DEPOSIT' ? '+' : '-'}{formatMoney(t.amount)}
                                        </span>
                                    </div>
                                ))}
                                {filteredTx.length === 0 && <p className="p-8 text-center text-slate-400 text-sm">No records found.</p>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 3. SETTINGS & STAFF MANAGEMENT
        const Settings = ({ appData, onAddStaff, onDeleteStaff, onBack }) => {
            const [newStaff, setNewStaff] = useState({ name: '', pin: '', role: 'staff' });

            const handleAdd = (e) => {
                e.preventDefault();
                if (newStaff.pin.length < 4) return alert("PIN must be 4 digits");
                onAddStaff(newStaff);
                setNewStaff({ name: '', pin: '', role: 'staff' });
            };

            const handleBackup = async () => {
                // For now, just dump local state as we don't have a full cloud export function ready
                // In a real app, this would query all collections.
                alert("Cloud Backup is handled automatically by Firebase. To export a local JSON of what's currently loaded:");
                const dump = JSON.stringify({ app: appData, timestamp: new Date() }, null, 2);
                const blob = new Blob([dump], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `yomola_backup_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
            };

            return (
                <div className="space-y-6">
                    <button onClick={onBack} className="text-slate-500 hover:text-slate-800 flex items-center gap-2 font-medium">
                        <i data-lucide="arrow-left" className="w-4 h-4"></i> Back to Dashboard
                    </button>

                    <h2 className="text-2xl font-bold text-slate-800">System Settings</h2>

                    {/* Data Management */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <h3 className="font-bold text-lg mb-4 flex items-center gap-2">
                            <i data-lucide="database" className="w-5 h-5 text-brand-600"></i> Data Management
                        </h3>
                        <div className="flex gap-4">
                            <button onClick={handleBackup} className="px-4 py-2 border rounded-lg hover:bg-slate-50 text-slate-700 font-medium text-sm flex items-center gap-2">
                                <i data-lucide="download" className="w-4 h-4"></i> Download Local Backup
                            </button>
                            <button onClick={() => { CloudService.clearConfig(); window.location.reload(); }} className="px-4 py-2 border border-red-200 text-red-600 rounded-lg hover:bg-red-50 font-medium text-sm flex items-center gap-2">
                                <i data-lucide="log-out" className="w-4 h-4"></i> Disconnect Cloud
                            </button>
                        </div>
                    </div>

                    {/* Staff Management */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <h3 className="font-bold text-lg mb-4 flex items-center gap-2">
                            <i data-lucide="users" className="w-5 h-5 text-brand-600"></i> Staff Management
                        </h3>

                        {/* Add Staff Form */}
                        <form onSubmit={handleAdd} className="bg-slate-50 p-4 rounded-lg mb-6 flex flex-col md:flex-row gap-4 items-end">
                            <div className="flex-1 w-full">
                                <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Staff Name</label>
                                <input required value={newStaff.name} onChange={e => setNewStaff({ ...newStaff, name: e.target.value })} className="w-full p-2 border rounded text-sm" placeholder="John Doe" />
                            </div>
                            <div className="w-full md:w-32">
                                <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">PIN</label>
                                <input required maxLength="4" value={newStaff.pin} onChange={e => setNewStaff({ ...newStaff, pin: e.target.value.replace(/\D/g, '') })} className="w-full p-2 border rounded text-sm" placeholder="1234" />
                            </div>
                            <div className="w-full md:w-32">
                                <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Role</label>
                                <select value={newStaff.role} onChange={e => setNewStaff({ ...newStaff, role: e.target.value })} className="w-full p-2 border rounded text-sm">
                                    <option value="staff">Staff</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            <button className="bg-brand-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-brand-700 w-full md:w-auto self-end">Add Staff</button>
                        </form>

                        {/* Staff List */}
                        <div className="space-y-2">
                            {appData.staff && appData.staff.map(s => (
                                <div key={s.id} className="flex justify-between items-center p-3 border rounded-lg bg-white">
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center font-bold text-xs">{s.name.substring(0, 2)}</div>
                                        <div>
                                            <p className="font-bold text-sm text-slate-900">{s.name} {s.role === 'admin' && <span className="text-xs text-brand-600 bg-brand-50 px-1 rounded ml-1">ADMIN</span>}</p>
                                        </div>
                                    </div>
                                    {s.role !== 'admin' || appData.staff.filter(st => st.role === 'admin').length > 1 ? (
                                        <button onClick={() => onDeleteStaff(s.id)} className="text-red-500 hover:text-red-700 p-2"><i data-lucide="trash-2" className="w-4 h-4"></i></button>
                                    ) : null}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // 5. MAIN APP LOGIC & STATE (Async & Cloud)
        const App = () => {
            const [session, setSession] = useState('loading'); // loading | setup | auth | app | client
            const [isLoading, setIsLoading] = useState(true);

            // Data State
            const [appData, setAppData] = useState({ staff: [] });
            const [clients, setClients] = useState([]);
            const [transactions, setTransactions] = useState([]);

            const [currentUser, setCurrentUser] = useState(null);
            const [view, setView] = useState('dashboard');
            const [selectedClientId, setSelectedClientId] = useState(null);
            const [notification, setNotification] = useState(null);

            // Initial Cloud Check
            useEffect(() => {
                const checkCloud = async () => {
                    setIsLoading(true);
                    const config = CloudService.loadConfig();
                    if (config) {
                        const success = CloudService.init(config);
                        if (success) {
                            setSession('auth');
                        } else {
                            CloudService.clearConfig();
                            setSession('setup');
                        }
                    } else {
                        setSession('setup');
                    }
                    setIsLoading(false);
                };
                checkCloud();
            }, []);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [session, view, clients, selectedClientId]);

            // Data Loader (Called on Login)
            const loadData = async () => {
                const [app, cls, txs] = await Promise.all([
                    CloudService.loadApp(),
                    CloudService.loadClients(),
                    CloudService.loadTransactions()
                ]);
                setAppData(app);
                setClients(cls);
                setTransactions(txs);
                return { app, cls };
            };

            // Handlers
            const handleConnect = () => {
                setSession('auth');
            };

            const handleLogin = async ({ type, pin, phone }) => {
                setIsLoading(true);
                try {
                    const { app, cls } = await loadData();

                    if (type === 'staff') {
                        // Staff Logic
                        const user = app.staff ? app.staff.find(u => u.pin === pin) : null;
                        if (user) {
                            setCurrentUser(user);
                            setSession('app');
                        } else {
                            alert("Invalid PIN");
                        }
                    } else {
                        // Client Logic
                        const client = cls.find(c => c.phone === phone);
                        if (client) {
                            setCurrentUser(client);
                            setSession('client');
                        } else {
                            alert("Phone number not found. Contact staff.");
                        }
                    }
                } catch (e) {
                    console.error("Login Error", e);
                    alert("Connection Error: " + e.message);
                }
                setIsLoading(false);
            };

            const handleSetup = async (pin) => {
                setIsLoading(true);
                // Create Admin on Cloud
                const newAdmin = { id: 1, name: 'Admin', pin, role: 'admin' };
                const newData = { businessName: 'Yomola Global', staff: [newAdmin] };

                await CloudService.saveApp(newData);
                setAppData(newData);
                setCurrentUser(newAdmin);
                setSession('app');
                setIsLoading(false);
            };

            const handleLogout = () => {
                setCurrentUser(null);
                setClients([]);
                setTransactions([]);
                setSession('auth');
                setView('dashboard');
            };

            // CRUD Handlers (Updated for Cloud)
            const handleAddStaff = async (staff) => {
                const newData = { ...appData, staff: [...(appData.staff || []), { ...staff, id: Date.now() }] };
                setAppData(newData);
                await CloudService.saveApp(newData);
                alert("Staff member created!");
            };

            const handleDeleteStaff = async (id) => {
                if (!confirm("Are you sure?")) return;
                const newData = { ...appData, staff: appData.staff.filter(s => s.id !== id) };
                setAppData(newData);
                await CloudService.saveApp(newData);
            };

            const addClient = async (client) => {
                setIsLoading(true);
                const updated = [client, ...clients];
                setClients(updated);
                await CloudService.saveClient(client);
                setIsLoading(false);
            };

            const handleTransaction = async (tx) => {
                setIsLoading(true);
                // Enterprise: Audit Trail
                const stampedTx = { ...tx, processedBy: currentUser?.name || 'Unknown' };

                // 1. Save Transaction locally & cloud
                const newTxs = [stampedTx, ...transactions];
                setTransactions(newTxs);
                await CloudService.saveTransaction(stampedTx);

                // 2. Update Balance locally & cloud
                // Find old client object
                const oldClient = clients.find(c => c.id === tx.clientId);
                if (oldClient) {
                    const newBal = tx.type === 'DEPOSIT' ? (oldClient.balance + tx.amount) : (oldClient.balance - tx.amount);
                    const updatedClient = { ...oldClient, balance: newBal };

                    const updatedClients = clients.map(c => c.id === tx.clientId ? updatedClient : c);
                    setClients(updatedClients);

                    await CloudService.saveClient(updatedClient);

                    // 3. Simulate Notification
                    const msg = `Notification: ${tx.type} of ${formatMoney(tx.amount)} for ${oldClient.name} successful.`;
                    setNotification(msg);
                    setTimeout(() => setNotification(null), 5000);
                }
                setIsLoading(false);
            };

            // Loading View
            if (isLoading || session === 'loading') return (
                <div className="flex h-screen items-center justify-center bg-brand-900 text-white flex-col">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-white mb-4"></div>
                    <p className="animate-bounce">Synchronizing with Cloud...</p>
                </div>
            );

            // Session Views
            if (session === 'setup') return <SetupScreen onConnect={handleConnect} />;
            if (session === 'auth') return <AuthScreen onLogin={handleLogin} onSetup={handleSetup} hasAccount={true} />; // Always assume init needs setup inside Auth if appData is empty, but logic handles it
            if (session === 'client') return <ClientPortal client={currentUser} transactions={transactions} onLogout={handleLogout} />;

            // STAFF APP VIEW
            // Routing
            let content;
            if (view === 'dashboard') content = <DashboardHome clients={clients} transactions={transactions} />;
            if (view === 'clients') content = <ClientManager clients={clients} onAddClient={addClient} onSelectClient={(id) => { setSelectedClientId(id); setView('client-detail'); }} />;
            if (view === 'settings') {
                // RBAC Check for Settings
                if (currentUser.role === 'admin') {
                    content = <Settings appData={appData} onAddStaff={handleAddStaff} onDeleteStaff={handleDeleteStaff} onBack={() => setView('dashboard')} />;
                } else {
                    content = (
                        <div className="flex flex-col items-center justify-center h-full text-slate-400">
                            <i data-lucide="lock" className="w-16 h-16 mb-4"></i>
                            <h2 className="text-xl font-bold">Access Restricted</h2>
                            <p>Only Administrators can access Settings.</p>
                            <button onClick={() => setView('dashboard')} className="mt-4 text-brand-600 hover:underline">Return to Dashboard</button>
                        </div>
                    );
                }
            }

            if (view === 'client-detail') {
                const client = clients.find(c => c.id === selectedClientId);
                if (client) {
                    content = <ClientDetail client={client} transactions={transactions} onBack={() => setView('clients')} onTransaction={handleTransaction} />;
                } else {
                    setView('clients');
                }
            }

            if (view === 'transactions') {
                const sortedTx = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
                content = (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h2 className="text-2xl font-bold text-slate-800">All Transactions</h2>
                            <div className="bg-white px-4 py-2 rounded-lg border text-sm font-medium text-slate-500">
                                Total Volume: {formatMoney(sortedTx.reduce((sum, t) => sum + t.amount, 0))}
                            </div>
                        </div>
                        <div className="bg-white rounded-xl shadow-sm overflow-hidden border border-slate-100">
                            <table className="w-full text-left text-sm">
                                <thead className="bg-slate-50 text-slate-500 font-medium border-b">
                                    <tr>
                                        <th className="p-4">Date</th>
                                        <th className="p-4">Client</th>
                                        <th className="p-4">Type</th>
                                        <th className="p-4">Method</th>
                                        <th className="p-4">Processor</th>
                                        <th className="p-4 text-right">Amount</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {sortedTx.map(t => {
                                        const client = clients.find(c => c.id === t.clientId);
                                        return (
                                            <tr key={t.id} className="hover:bg-slate-50 transition">
                                                <td className="p-4 text-slate-500">{t.date}</td>
                                                <td className="p-4 font-medium text-slate-900">{client ? client.name : 'Unknown Client'}</td>
                                                <td className="p-4">
                                                    <span className={`px-2 py-1 rounded text-xs font-bold ${t.type === 'DEPOSIT' ? 'bg-emerald-50 text-emerald-700' : 'bg-red-50 text-red-700'}`}>
                                                        {t.type}
                                                    </span>
                                                </td>
                                                <td className="p-4 text-slate-600">{t.method}</td>
                                                <td className="p-4 text-xs font-mono text-slate-500 uppercase">{t.processedBy || 'Admin'}</td>
                                                <td className={`p-4 text-right font-bold ${t.type === 'DEPOSIT' ? 'text-emerald-600' : 'text-red-600'}`}>
                                                    {t.type === 'DEPOSIT' ? '+' : '-'}{formatMoney(t.amount)}
                                                </td>
                                            </tr>
                                        );
                                    })}
                                    {sortedTx.length === 0 && <tr><td colSpan="6" className="p-8 text-center text-slate-400">No transactions found.</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            }
            if (view === 'reports') {
                const totalDeps = transactions.filter(t => t.type === 'DEPOSIT').reduce((s, t) => s + t.amount, 0);
                const totalWith = transactions.filter(t => t.type === 'WITHDRAWAL').reduce((s, t) => s + t.amount, 0);
                const netGrowth = totalDeps - totalWith;

                // 7-Day Chart Data
                const today = new Date();
                const chartData = Array.from({ length: 7 }, (_, i) => {
                    const d = new Date(today);
                    d.setDate(today.getDate() - (6 - i));
                    const dateStr = d.toISOString().slice(0, 10);
                    const vol = transactions.filter(t => t.date === dateStr && t.type === 'DEPOSIT').reduce((s, t) => s + t.amount, 0);
                    return { date: dateStr.slice(5), volume: vol };
                });
                const maxVol = Math.max(...chartData.map(d => d.volume), 1); // Avoid div by 0

                // Top Clients
                const topClients = [...clients].sort((a, b) => b.balance - a.balance).slice(0, 5);

                content = (
                    <div className="space-y-6">
                        <h2 className="text-2xl font-bold text-slate-800">Agency Reports</h2>

                        {/* Summary Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                <p className="text-xs font-bold text-slate-500 uppercase">Net Growth</p>
                                <p className={`text-3xl font-bold mt-2 ${netGrowth >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                    {netGrowth >= 0 ? '+' : ''}{formatMoney(netGrowth)}
                                </p>
                            </div>
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                <p className="text-xs font-bold text-slate-500 uppercase">Total Deposits</p>
                                <p className="text-3xl font-bold text-slate-800 mt-2">{formatMoney(totalDeps)}</p>
                            </div>
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                <p className="text-xs font-bold text-slate-500 uppercase">Total Withdrawals</p>
                                <p className="text-3xl font-bold text-red-600 mt-2">-{formatMoney(totalWith)}</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            {/* Chart */}
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                <h3 className="font-bold text-lg mb-6">Deposits (Last 7 Days)</h3>
                                <div className="flex items-end justify-between h-48 gap-2">
                                    {chartData.map((d, i) => (
                                        <div key={i} className="flex-1 flex flex-col justify-end items-center group">
                                            <div
                                                className="w-full bg-brand-500 rounded-t-lg transition-all duration-500 group-hover:bg-brand-600 relative"
                                                style={{ height: `${(d.volume / maxVol) * 100}%` }}
                                            >
                                                <div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap">
                                                    {formatMoney(d.volume)}
                                                </div>
                                            </div>
                                            <p className="text-xs text-slate-400 mt-2 font-medium">{d.date}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Top Clients */}
                            <div className="bg-white p-0 rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                                <div className="p-6 border-b border-slate-100">
                                    <h3 className="font-bold text-lg">Top 5 Savers</h3>
                                </div>
                                <table className="w-full text-left text-sm">
                                    <tbody className="divide-y divide-slate-100">
                                        {topClients.map((client, i) => (
                                            <tr key={client.id} className="hover:bg-slate-50">
                                                <td className="p-4 pl-6 text-slate-400 font-bold w-12 text-center">{i + 1}</td>
                                                <td className="p-4 font-medium text-slate-900">{client.name}</td>
                                                <td className="p-4 text-right font-bold text-brand-600">{formatMoney(client.balance)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <Layout onViewChange={setView} currentView={view} onLogout={handleLogout} currentUser={currentUser}>
                    {content}
                    {notification && <NotificationToast message={notification} onClose={() => setNotification(null)} />}
                </Layout>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
